- name: Installing github keys binary
  copy: src=bin/gh-keys dest=/usr/sbin/gh-keys mode=0755

- name: Installing custom SSHD config
  copy: src=conf/sshd_config dest=/etc/ssh/sshd_config backup=yes

- name: Restarting sshd to use new configuration
  command: "/usr/bin/systemctl restart sshd"

# digital ocean fix since they have a bug in newly booted fedora droplets
- name: Disable rngd (if present)
  command: "/usr/bin/systemctl disable rngd.service || true"

- name: install basic packages
  yum: pkg={{item}} state=installed
  with_items:
    - gcc
    - make
    - git
    - mercurial
    - wget
    - curl
    - nc
    - unzip
    - tcpdump
    - openssl-devel
    - gcc-c++
    - golang
    - words
    - fish
    - bc
    - unzip
    - rpm-build
    - bind-utils
    - tree
    - nano
#    - python-pip
#    - tmux

- name: Install latest docker from binary
  get_url:
    url: "https://get.docker.io/builds/Linux/x86_64/docker-latest"
    dest: /usr/bin/docker
    mode: 0755
    force: yes


- name: "Create extra convention dirs"
  file: path={{ item }} state=directory
  with_items:
     - /usr/local/rc.d
     - /srv/rc.d
     - /srv/bin

- name: Installing motd
  copy: src=conf/motd dest=/etc/motd
  tags: motd

- name: Installg profile.d path-additions
  copy: src=bin/path-additions.sh dest=/etc/profile.d/path-additions.sh mode=0755

- name: Finding local user to be managed
  filter: 
    items: "{{managed_users}}"
    test: "id __item__ &> /dev/null"
    fact: target_users

- name: Creating rc.local script
  copy: src=bin/rc-local.sh dest=/usr/bin/rc-local mode=0755

- name: Copying systemd units
  copy: "src=system/{{item}} dest=/etc/systemd/system/{{item}}"
  with_items:
    - docker.service
    - rc-local.service
    - server.target
    - sshd-shutdown.service

- name: Updating systemd daemon
  command: "/usr/bin/systemctl daemon-reload"

- name: Enabling units
  command: "/usr/bin/systemctl enable /etc/systemd/system/{{item}}"
  with_items:
    - docker.service
    - server.target
    - rc-local.service
    - sshd-shutdown.service 

- name: Restarting units
  command: "/usr/bin/systemctl restart {{item}}"
  with_items:
    - docker.service
    - server.target

- name: Pulling vlipco/mini into docker
  command: /usr/bin/docker pull vlipco/mini

- name: Creating auto-hostname script in local rc.d
  copy: src=bin/auto-hostname.sh dest=/usr/local/rc.d/auto-hostname mode=0755
